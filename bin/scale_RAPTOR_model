#!/usr/bin/env lua
--- Changes 3dmod model file produced by RAPTOR to better erase gold.
--
-- This program takes a fiducial model generated automatically by RAPTOR and
-- scales and changes its properties to make it better for erasing gold and for
-- computing the alignment using IMOD tiltalign
--
-- Dependencies: `MRC_IO_lib`, `tomoauto_lib`
--
-- @script scale_RAPTOR_model
-- @author Dustin Morado
-- @license GPLv3
-- @release 0.2.10

local tomoauto_directory = os.getenv('TOMOAUTOROOT')
package.path = package.path .. ';' .. tomoauto_directory .. '/lib/?.lua;'

local MRC_IO_lib  = require 'MRC_IO_lib'
local tomoauto_lib   = require 'tomoauto_lib'

--- Alters 3dmod model file produced by RAPTOR to better erase gold.
-- Scales the model to the original dataset, and makes the model point size
-- bigger to better erase gold.
-- @param input_filename RAPTOR generated fiducial model e.g image.fid.txt
-- @param output_filename Output fiducial model filename e.g image.fid
function scale_RAPTOR_model(input_filename, output_filename)
   local basename  = string.sub(input_filename, 1, -9)
   local input_stack_filename = basename .. '.st'
   local header = MRC_IO_lib.get_header(input_stack_filename)

   tomoauto_lib.scale_RAPTOR_model(input_filename, header, output_filename)
end

if not arg[1] then
   print('\nUsage: scale_RAPTOR_model <image.fid.txt> <image.fid>\n\n')
   os.exit(0)
end

local status, err = pcall(scale_RAPTOR_model, arg[1], arg[2])
if not status then
   io.stderr:write(err)
   os.exit(1)
else
   os.exit(0)
end
